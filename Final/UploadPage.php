
<?php
session_start();

// to avoid illegal back tracking
if(empty($_SESSION['id']) || $_SESSION['ua'] != $_SERVER['HTTP_USER_AGENT']){
  header("Location: login.php");
}

echo "WELCOME: ".ucfirst($_SESSION['name']);

//HTML
echo<<<END

<!doctype = html>
<html lang = "en">
<head>
  <title> Malware upload page</title>
  <script>
  function validateForm(){

    var value = document.forms["form1"]["title"].value;

    var fail = "";
    fail = this.validateTitle(value);
    if(fail == "") return true;
    else{
      alert(fail);
      return false;
    }
  }

  function validateTitle(name){
    if(name =="") return "Title not found \n";
    else if(/[^a-zA-Z0-9_-]/.test(name))
    return "Invalid character found on title \n";
    else
    return "";
  }


  </script>
</head>
<body>
  <h1>Malware Analyzer</h1>

  <form method="post" id = "form1" name ="form1" action = "UploadPage.php" onsubmit="return validateForm()">
    <label for="title">Malware Name: </label>
    <input type="text" name = "title" id = "title" accept="text/plain" />
    <br />
    <label for="file">Filename:</label>
    <input type="file" name="file" id="file" accept ="text/plain"/>
    <br />
    <input type="submit" value="Submit" name="submit">
    <br />
    <input type="submit" value ="Logout" name ="logout">
  </form>

</body>
</html>

END;

$readByte = true;
$signature = "";
$admin = false;
$title = "";


//logout with killing session
if(isset($_POST['logout'])){
 session_unset();
 session_destroy();
 mysqli_close($connection);
 header("Location: UploadPage.php");

}



if(isset($_POST['submit']))
{
  if(isset($_POST['title'])){
    start();
  }
  else
  {
    echo "<br /> insert malware title please";
  }
}

function start(){
    require 'mysql_connect.php';

  global $readByte;
  global $signature;
  global $title;

  $debug = true;

  $found = false;
  if($_SESSION['id'] <0)
    $admin = false;
  else {
      $admin = true;
  }

//sanitizing title
  $title = fix_string($_POST['title']);
  $file = $_POST['file'];

  if($title == ""){
    echo "<br /> File name not found";
    exit(0);
  }else if(!validate_filename($title) == ""){
    //check if filename is legal
    echo (validate_filename($title));
  }

  if(!file_exists($_POST['file']))
  {
    echo "<br /> FILE NOT FOUND";
    exit(0);
  }
  else{
    $found = crosscheckBytes();
    if($found){
      echo("MALWARE FOUND");
    }else{
      echo("MALWARE NOT FOUND");
    }

    // upload new malware
    if(!$found && $admin)
    {
      // get signature and insert into db;
      if($readByte)
        // reading bytes of the file
        $signature = read_byte($file);
      else
      //reading contents of the file.
        $signature = read_not_byte($file);

      // retrive the sessions from previous page.
      $userId= $_SESSION['id'];
      $userName =$_SESSION['name'];
      // sql query to insert new malware signature
      $query = "INSERT INTO malwares VALUES (NULL,  '$title', $signature,CURRENT_TIMESTAMP,'$userId');";
      $result = $connection->query($query);
      if (!$result) die ($connection ->error);
      else {
        echo "<br /> New Malware ".$title."has been inserted successfully.";
        echo "<br /> Thankyou ".ucfirst($userName)." for your contribution.";
      }
    }
  }
}

// get byte signature from file
function read_byte($filename){
  $sig = "";

  $handle = fopen($filename, "rb");
  $fsize = filesize($filename);
  $contents = fread($handle, $fsize);
  $byteArray = unpack("N*",$contents);

  if(sizeof($byteArray)<= 0 ){
    $sig = "null";
  }else if(sizeof($byteArray) < 2 ){
    $sig = $byteArray [1];
  }
  else{
    $sig = $byteArray [1];
    $sig .= $byteArray [2];
  }

  fclose($handle);

  return $sig;
}

//read the contents of the file
function read_not_byte($filename){
  $handle = fopen($filename, "r");

  $contents = fix_string(fread($handle,20));

  fclose($handle);

  return $contents;
}


//Sanitization
function fix_string($input){
  if (get_magic_quotes_gpc()) $input = stripslashes($input);
  return htmlentities($input);
}

// DB Vs Uploaded file check
function crosscheckBytes(){
  require 'mysql_connect.php';

  $file = $_POST['file'];
  $handle = fopen($file, "rb");
  $fsize = filesize($file);
  $contents = fread($handle, $fsize);
  $byteArray = unpack("N*",$contents);
  // get binary of the file
  echo ("<br />");
  $binaryData = "";
  foreach($byteArray as $key => $block)
  {
    $binaryData .= $block;
  }

  //get array of signatures
  $searchQuery =  "SELECT signature FROM malwares ;";
  $searchResult = $connection -> query($searchQuery);
  if (!$searchResult) die ($connection->error);
  elseif ($searchResult ->num_rows){
    while ($row = $searchResult->fetch_array(MYSQLI_NUM)){
      // check pattern of the DB signature with file.
      $pattern = "/$row[0]/";
      $foundValue = preg_match($pattern, $binaryData);
      if($foundValue == 1) return true;
    }
  }

  return false;
}

//validating malware input name
function validate_filename($string){
  //check if empty
  if($string == "") return "file not inserted <br />";
  else if(!preg_match("/[^a-zA-Z0-9_-]/", $string))
    return "illegal characters on file name found <br />";
  return "";
}

?>
