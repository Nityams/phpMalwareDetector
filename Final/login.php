
<?php

  require 'mysql_connect.php';

//start session
  session_start();
  echo<<<END

<!DOCTYPE html>
<head>
  <title> Login page in action</title>
  <script>
    function validateForm(){
      var value = document.forms["form"]["user"].value;
      var value3 =document.forms["form"]["password"].value;

      var fail = "";
      fail = this.validateUserName(value);
      fail += this.validateUserPassword(value3);

      if(fail == "") return true;
      else {
            alert(fail);
            return false;
          }
    }

    function validateUserName(name){
      if(name == "") return " JS - user name not found \n";
      else if(name.length <5){
        return "JS- name too short, must be atleast 5 chars long \n";
      }else if (/[^a-zA-Z0-9_-]/.test(name))
        return "JS- invalid user name characters \n";
      return "";

      // return "hs- name error"
    }

    function validateUserPassword(password){
      if(password == "")
        return "JS- password not found \n";
      else if(password.length < 6)
        return "JS- password must be atleast 6 chars long \n";
      else if(!(/[a_z]/.test(password)) ||
                !(/[A-Z]/.test(password)) ||
                !(/[0-9]/.test(password)))
        return "JS- password must contain caps, small and number \n";
      else
        return "";
    }

  </script>
</head>
<body>


<form name ="form" action="login.php" onsubmit="" method ="post" id ="form" >
Username: <input type="text" maxlength="32" name="user" id = "user" ><br>
Password: <input type="password" maxlength="32" name="password" id = "password" ><br>

<input type ="submit" value ="Login" />
</form>

<h4> If your username or password is wrong, you will be logged in as Guest</h4>

</body>
</html>

END;


$username = $password ="";
$fail = "";

if(isset($_POST['user']))
{  $username = fix_string($_POST['user']);
      $username = strtolower($username);
}
if(isset($_POST['password']))
  {$password =fix_string($_POST['password']);
    $fail .= validate_pass($password);
    $fail .= validate_username($username);
    $password = saltBae($password);
  }

  //salting the passsword for database
function saltBae($pas){
  $comp1 = "cl@r@";
  $comp2 = "0_wald";
  $final = $comp1.$pas.$comp2;
  $salty = hash('ripemd128',$final);
  return $salty;
}

//Sanitization of the string
function fix_string($string){
  if (get_magic_quotes_gpc()) $string = stripslashes($string);
  return htmlentities($string);
}

//validating the username
function validate_username($string){
  if($string == "") return "php- username not inserted <br />";
  else if(strlen($string) < 5)
    return " username must be 5char long <br />";
  else if(preg_match("/[^a-zA-Z0-9_-]/", $string|| !preg_match("/[A-Z]/",$string) || !preg_match("/[0-9]/",$string)))
    return " illegal chars found on username<br />";
  return "";
}
//validating the pasword
function validate_pass($string){
  if($string =="") return "Password not found <br />";
  else if(strlen($string) < 6)
    return "passwords must be atleast 6 chars long <br />";
  else if(!preg_match("/[a-z]/",$string) || !preg_match("/[A-Z]/",$string) || !preg_match("/[0-9]/",$string) )
    return "Password must contain capital letters, small letters and numbers <br />";
  return "";
}

//backend authentication
if(isset($_POST['user'])){
  if($fail == ""){
    authentication($username, $password);
  }else{
    echo $fail;
  }
}

//cross checking with the db
function authentication($u, $p){
  require 'mysql_connect.php';

  echo $p;
  $query = "SELECT * FROM admins WHERE username = '$u' AND secretPas = '$p'";

  $searchResult = $connection -> query($query);
  if (!$searchResult) die ($connection->error);
  elseif ($searchResult ->num_rows){
    while ($row = $searchResult->fetch_array(MYSQLI_NUM)){
      // if admin, store the session and go to the next page
      $_SESSION['id'] = $row[0];
      $_SESSION['name'] = $row[1];
      $_SESSION['ua'] = $_SERVER['HTTP_USER_AGENT'];
      header("Location: UploadPage.php");
      mysqli_close($connection);
      break;
    }
  }else{
    //if not admin, log in as guest.
    $_SESSION['id'] = -1;
    $_SESSION['name'] = "guest";
    $_SESSION['ua'] = $_SERVER['HTTP_USER_AGENT'];
    header("Location: UploadPage.php");
    mysqli_close($connection);
  }

}
?>
